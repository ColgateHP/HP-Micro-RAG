name: Advanced RAG Knowledge Graph Builder

on:
  workflow_dispatch:
    inputs:
      topic:
        description: '知识图谱的主题 (例如: 培养基管理)'
        required: true
        default: '培养基管理'

jobs:
  build-and-run:
    runs-on: ubuntu-latest

    steps:
    # 步骤1：检出您的代码
    - name: Checkout repository
      uses: actions/checkout@v4

    # 步骤2：设置Python 3.11环境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    # 步骤3：配置缓存
    - name: Cache dependencies and PaddleOCR models
      uses: actions/cache@v4
      with:
        path: |
          ~/.cache/pip
          /home/runner/.paddleocr/
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 步骤4：安装系统级依赖 (已修正)
    - name: Install system dependencies
      run: |
        sudo apt-get update
        # 修正：'libgl1-mesa-glx' 已被替换为更标准的 'libgl1'
        sudo apt-get install -y libgl1 libglib2.0-0

    # 步骤5：安装Python包
    - name: Install Python dependencies
      run: python -m pip install -r requirements.txt

    # 步骤6：运行主程序
    - name: Run Knowledge Graph Builder
      env:
        GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
        HOME: /home/runner
      run: |
        python -m src.main --topic "${{ github.event.inputs.topic }}"
